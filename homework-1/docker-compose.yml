services:
  # H2 Database - TCP Server Mode (Development Profile)
  h2-dev:
    image: oscarfonts/h2:2.2.224
    container_name: bank-h2
    restart: unless-stopped
    networks:
      - bank-net
    volumes:
      - h2-data:/opt/h2-data
    environment:
      - H2_OPTIONS=-ifNotExists -tcp -tcpAllowOthers -tcpPort 9092 -baseDir /opt/h2-data
    ports:
      - "8082:8082"  # H2 Web Console (dev only)
    profiles:
      - dev
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/9092' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # H2 Database - TCP Server Mode (Production Profile)
  h2:
    image: oscarfonts/h2:2.2.224
    container_name: bank-h2
    restart: unless-stopped
    networks:
      - bank-net
    volumes:
      - h2-data:/opt/h2-data
    environment:
      - H2_OPTIONS=-ifNotExists -tcp -tcpAllowOthers -tcpPort 9092 -baseDir /opt/h2-data
    # No ports exposed to host in production
    profiles:
      - prod
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/9092' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Backend API + Frontend (Mode A: Single Entrypoint)
  backend:
    build:
      context: .
      dockerfile: bank_api/Dockerfile
    container_name: bank-backend
    restart: unless-stopped
    networks:
      - bank-net
    ports:
      - "80:8000"
    environment:
      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ALG=${JWT_ALG:-HS256}
      - JWT_TTL=${JWT_TTL:-900}
      
      # Database Configuration - TCP mode to H2 container
      - H2_JAR_PATH=/app/h2.jar
      - DB_URL=jdbc:h2:tcp://h2:9092/bank;MODE=PostgreSQL
      - DB_USER=${DB_USER:-sa}
      - DB_PASSWORD=${DB_PASSWORD:-}
      - DB_DRIVER=org.h2.Driver
      
      # CORS Configuration
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost,http://localhost:80}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      
      # Admin seeding (optional)
      - ADMIN_EMAIL=${ADMIN_EMAIL:-}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-}
    depends_on:
      h2:
        condition: service_healthy
        required: false
      h2-dev:
        condition: service_healthy
        required: false
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    profiles:
      - prod
      - dev

networks:
  bank-net:
    driver: bridge

volumes:
  h2-data:
    driver: local
