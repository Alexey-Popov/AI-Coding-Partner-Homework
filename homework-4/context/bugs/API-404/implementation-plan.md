````markdown
# Implementation Plan: API-404

Generated by: bug-planner agent
Input: context/bugs/API-404/research/verified-research.md (RQ-4)
Status: READY

## Plan Summary

Fix `GET /api/users/:id` so requests for numeric path IDs (e.g. `/api/users/123`) return the matching user instead of 404. The controller currently compares a numeric `id` in the in-memory store to the string `req.params.id` using `===`. Change the controller to parse and validate the path parameter to a Number, use the numeric value for lookup, and return `400 Bad Request` for non-numeric IDs. Expected outcome: successful lookups for valid numeric IDs, 400 for invalid IDs, and clear unit/acceptance tests covering the regression.

## Preconditions

- Verified research exists: `context/bugs/API-404/research/verified-research.md` (RQ-4).
- Repository is checked out with no uncommitted changes to `demo-bug-fix/src/controllers/userController.js`.
- Node.js available for running the demo server and tests (used by QA).

## Files To Change

| File | Change Type |
|------|-------------|
| demo-bug-fix/src/controllers/userController.js | Modify |
| demo-bug-fix/package.json | Modify (optional: add `test` script and `jest` devDependency) |
| tests/userController.test.js | Add (unit tests for regression and edge cases) |

## Step-by-Step Changes

### Step 1: Convert path param to number and validate

**File**: demo-bug-fix/src/controllers/userController.js
**Location**: function `getUserById` (around lines where `userId` and `users.find` are used)
**Before behavior**: The controller reads `const userId = req.params.id;` (a string) and performs `users.find(u => u.id === userId);` which never matches numeric IDs and results in 404.
**After behavior**: The controller will parse `req.params.id` into a numeric variable, validate it, and then perform the numeric comparison to find the user. If parsing fails, the controller returns `400` with an explanatory error.
**Change**:
```
// Before
const userId = req.params.id;
const user = users.find(u => u.id === userId);

// After (minimal)
const userIdNum = Number(req.params.id);
if (!Number.isInteger(userIdNum)) {
  return res.status(400).json({ error: 'Invalid user id' });
}
const user = users.find(u => u.id === userIdNum);
```

Notes:
- Use `Number.isInteger(...)` to reject non-integer IDs (adjust if strings or floats are expected).
- Keep the existing 404 behavior for numeric-but-nonexistent IDs.

### Step 2 (optional but recommended): Add unit tests

**File**: tests/userController.test.js (new)
**Location**: new test suite covering `getUserById` behavior
**Before behavior**: No unit tests covering this regression.
**After behavior**: Unit tests exercise:
- Success: numeric string path `'123'` returns user with id 123.
- Not found: numeric string `'999'` returns 404 behavior.
- Invalid: non-numeric `'abc'` returns 400.

Test implementation notes:
- Prefer lightweight function-level tests by requiring the controller module and calling `getUserById` with mocked `req`/`res` objects (no HTTP server start required). Follow the FIRST rubric: fast, independent, repeatable, self-validating, timely.
- If the repo uses Jest, add `jest` devDependency and `test` script. Otherwise, add a minimal `node`-based test harness that runs the test file.

### Step 3 (optional): Update `package.json` test script

**File**: demo-bug-fix/package.json
**Before**: no test script.
**After**: add `"test": "jest --runInBand"` and add `jest` to devDependencies, or provide an alternative script to run the node-based tests.

## Test Commands

Manual acceptance (quick check):

```bash
cd demo-bug-fix
npm start &
# wait for server to start, then:
curl -i http://localhost:3000/api/users/123    # Expect 200 with Alice object
curl -i http://localhost:3000/api/users/999    # Expect 404 with { error: 'User not found' }
curl -i http://localhost:3000/api/users/abc    # Expect 400 with { error: 'Invalid user id' }
```

Unit tests (recommended):

If using Jest (recommended):

```bash
cd demo-bug-fix
npm install --save-dev jest
# from repo root
npm --prefix demo-bug-fix test
```

If adding a node-based harness (no new deps):

```bash
node tests/userController.test.js
```

## Validation Checklist

- [ ] `GET /api/users/123` returns HTTP 200 and the expected user JSON.
- [ ] `GET /api/users/999` returns HTTP 404 with `{ error: 'User not found' }`.
- [ ] `GET /api/users/abc` returns HTTP 400 with `{ error: 'Invalid user id' }`.
- [ ] Unit tests pass locally and exercise success, not-found, and invalid-id cases.
- [ ] No other endpoints were changed; `GET /api/users` still returns the user list.

## Stop Conditions / Escalations

Stop and escalate to the reporter/owner if any of the following occur:

- The users data store is not numeric IDs in other environments (e.g., production uses strings) — do not deploy without confirming ID type across environments.
- Unit tests fail for unrelated reasons (e.g., global state changes, test harness issues) — investigate before proceeding.
- Precision issues: if IDs larger than 2^53 are in use, Number conversion may lose precision; escalate to architect to decide on string/BigInt strategy.

Rollback guidance:

- If the change causes regressions, revert the single file `demo-bug-fix/src/controllers/userController.js` to the previous commit using `git checkout -- demo-bug-fix/src/controllers/userController.js` and re-run tests.

## References

- context/bugs/API-404/research/verified-research.md
- demo-bug-fix/src/controllers/userController.js
- demo-bug-fix/src/routes/users.js
- demo-bug-fix/server.js
- demo-bug-fix/package.json

````
