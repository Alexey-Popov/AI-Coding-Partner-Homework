# Codebase Research

Generated by: bug-researcher agent
Status: COMPLETE

## Bug Summary

GET /api/users/:id returns HTTP 404 for IDs that exist in the in-memory `users` array. The endpoint is called with a numeric-looking path segment (e.g. `123`) but the controller's lookup uses strict equality between a numeric `id` in the array and the string `req.params.id`, causing the find to fail and a 404 to be returned.

## Reproduction Path

1. Start the demo server from the repository root:

   npm start

2. Call the endpoint for an existing user:

   curl http://localhost:3000/api/users/123

3. Observe a 404 response with body `{ "error": "User not found" }` instead of the user object.

(See demo-bug reproduction in [demo-bug-fix/bugs/API-404/bug-context.md](demo-bug-fix/bugs/API-404/bug-context.md)).

## Code Findings

- File: [demo-bug-fix/src/controllers/userController.js](demo-bug-fix/src/controllers/userController.js#L6-L11)
  - Snippet (users array):
    - lines 6–11 show numeric IDs in the in-memory store: { id: 123, ... }, { id: 456, ... }, { id: 789, ... }.
- File: [demo-bug-fix/src/controllers/userController.js](demo-bug-fix/src/controllers/userController.js#L18-L24)
  - Snippet (lookup and bug comment):
    - lines 18–24 contain the `getUserById` implementation. Notably:
      - line 19: `const userId = req.params.id;`
      - lines 21–22: comments noting the bug about string vs numeric types.
      - line 23: `const user = users.find(u => u.id === userId);` — the actual failing comparison.
- File: [demo-bug-fix/src/routes/users.js](demo-bug-fix/src/routes/users.js#L10-L14)
  - Snippet (routes):
    - line 11 registers `GET /api/users` and line 14 registers `GET /api/users/:id` which routes to `getUserById`.
- File: [demo-bug-fix/server.js](demo-bug-fix/server.js#L15-L16)
  - Snippet (mounting routes):
    - line 16 mounts the routes with `app.use(userRoutes);` so the router paths are used as-is.

Observations (confirmed):
- The in-memory user IDs are numeric values (numbers) [demo-bug-fix/src/controllers/userController.js#L6-L11].
- `req.params.id` is read directly into `userId` (a string) [demo-bug-fix/src/controllers/userController.js#L19].
- The code uses strict equality (`===`) to compare `u.id` (number) and `userId` (string) [demo-bug-fix/src/controllers/userController.js#L23], which does not coerce types and therefore fails for identical numeric values expressed as strings.

Hypothesis (strongly supported by code and standard Express behavior):
- Express provides path parameters as strings; therefore the comparison `u.id === userId` will always be false for numeric IDs unless types are coerced or converted. The inline comment in the file also documents this issue [demo-bug-fix/src/controllers/userController.js#L21-L22].

## Root Cause Analysis

Root cause (precise): The controller's user lookup performs a strict equality comparison between the stored user `id` (a number) and `req.params.id` (a string) without normalizing types, so the predicate never matches and the controller returns 404. This is confirmed by the code at [demo-bug-fix/src/controllers/userController.js#L19-L24].

Why this manifests at runtime: Express populates `req.params` values as strings. When a route is requested with `/api/users/123`, `req.params.id` equals the string "123"; comparing that to the numeric 123 with `===` yields false, so `users.find(...)` returns undefined.

Confirmed evidence:
- Numeric IDs in data: [demo-bug-fix/src/controllers/userController.js#L6-L11].
- String assignment from params: [demo-bug-fix/src/controllers/userController.js#L19].
- Failing strict comparison: [demo-bug-fix/src/controllers/userController.js#L23].

No other control flow or middleware intervenes to convert parameter types (server mounts routes without body/param coercion) — see route mounting at [demo-bug-fix/server.js#L15-L16] and route definitions at [demo-bug-fix/src/routes/users.js#L10-L14].

## Proposed Fix Surface

Minimum viable fix (smallest change):
- Change the lookup in `getUserById` to compare the numeric form of the path param with the stored numeric ID. For example, replace:
  - `const user = users.find(u => u.id === userId);` (line 23)
  with
  - `const user = users.find(u => u.id === Number(userId));`
  or
  - parse `userId` earlier: `const userIdNum = Number(req.params.id);` then use `u.id === userIdNum`.

Files/lines to change:
- `demo-bug-fix/src/controllers/userController.js` — modify lines 19 and 23 (the `userId` assignment and the `.find(...)` call) to perform numeric conversion and validation.

Optional hardening (recommended):
- Validate the path parameter and return `400 Bad Request` for non-numeric IDs rather than 404 (e.g., if Number(userId) is NaN).
- Use `Number.isInteger(userIdNum)` or additional checks to reject floats if IDs are expected to be integers.
- Add unit tests that assert the controller behavior for valid, invalid, and edge-case params.

## Risks and Edge Cases

- If external callers rely on non-numeric IDs in future, converting to `Number` will break those calls. Current data uses numbers so risk is low.
- Converting very large numeric strings may lose precision — if IDs are large (>2^53) consider using string IDs consistently or BigInt handling.
- If the codebase later switches to string IDs for persistence, converting to `Number` will become incorrect — keep data type consistent across layers.
- If `userId` is non-numeric (e.g., `abc`), `Number(userId)` yields `NaN`; code should handle this and return `400` instead of treating it as `not found`.

## Suggested Test Cases

- Regression: `GET /api/users/123` returns 200 and the user object for the existing user with id 123.
  - Verify response JSON equals the object at [demo-bug-fix/src/controllers/userController.js#L8-L8].
- Valid numeric string IDs: `GET /api/users/456` returns user with id 456.
- Non-existent numeric ID: `GET /api/users/999` returns 404.
- Non-numeric ID: `GET /api/users/abc` returns 400 (if validation added) or 404 (if only numeric conversion and lookup used). Prefer 400 with validation.
- Edge: Leading zeros `GET /api/users/0123` — verify behavior is consistent (Number('0123') -> 123). Test if leading zeros are acceptable.
- Large ID handling: `GET /api/users/9007199254740993` — test for precision issues if applicable.

## References

- demo-bug-fix/src/controllers/userController.js (inspect lines):
  - users array: [demo-bug-fix/src/controllers/userController.js#L6-L11]
  - getUserById: [demo-bug-fix/src/controllers/userController.js#L18-L24]
- demo-bug-fix/src/routes/users.js (routes): [demo-bug-fix/src/routes/users.js#L10-L14]
- demo-bug-fix/server.js (route mounting): [demo-bug-fix/server.js#L15-L16]
- demo-bug-fix/bugs/API-404/bug-context.md (original report): [demo-bug-fix/bugs/API-404/bug-context.md](demo-bug-fix/bugs/API-404/bug-context.md)


